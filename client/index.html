<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isotown</title>
    <link rel="stylesheet" href="pixelspeechbubbles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="p5viewerclass.js"></script>
    <script src="bouncyBallClass.js"></script>
    <script src="cellclass.js"></script>
    <script src="gridclass.js"></script>
    <script src="viewmode.js"></script>
    <script src="sketch.js" defer></script>
    <link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet">
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <script src="intro-to-index.js" defer></script>
    <script type="module" src="./editcellComponent.js"></script>
    <script src="audiomessage-component.js"></script>
    <script src="textmessage-component.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="index.css">
    <!-- socket.io from cdn   -->
    <script src="https://cdn.socket.io/4.1.3/socket.io.min.js"></script>
    <!-- mainnavigagtion.js -->
    <script src="mainnavigation.js" defer></script>
</head>



<body>

<main-navigation
    onnortheast="grid.stepNorthEast()"
    onsoutheast="grid.stepSouthEast()"
    onsouthwest="grid.stepSouthWest()"
    onnorthwest="grid.stepNorthWest()"
    onmessage="()=>{console.log('message button pressed')}"
    onplus="viewMode.editCellStart()">
</main-navigation>

<cell-editor></cell-editor>



<div id="temp-image-holder" style="display:none"></div>


</body>

<script>



    // listen for         this.dispatchEvent(new CustomEvent('cancel-editing-cell'));
    document.addEventListener('cancel-editing-cell', () => {
        console.log('cancel-editing-cell event received');
        viewMode.editCellStop();
        viewMode.placeBuildingStop();
    });


   

    // leave a cookie so we know the user has been here before

    confirmPlacingCell = async function () {
        if(!placeBuildingMode) {
            console.error('Not in place building mode');
            return;
        }
        if(!buildingToPlace) {
            console.error('No building to place');
            return;
        }

        var cell = buildingToPlace;
        // get active cell 
        cell.i = grid.activeCell.i;
        cell.j = grid.activeCell.j;
        console.log('Placing cell:', cell);
        return saveCellToDatabase(cell).then(response => {
            // if 409 conflict, alert user
            if(response.status === 409) {
                alert('Sorry, someone built something here just this second... please choose another place.');
                return;
            }
            if(response.status !== 201) {
                console.error('Error saving cell:', response);
                return;
            }
            if(response.status === 201) {
                console.log('Cell saved successfully');
                const cellEditor = document.querySelector('cell-editor');
                cellEditor.resetAll();
                viewMode.placeBuildingStop();
                // broadcast event to all clients
                socket.emit('new-cell-created', cell);
            }

            // in any case, pull the updated cell data from the server
            updateCell(cell.i, cell.j);
            
        }).catch(error => {
            console.error('Error saving cell:', error);
        });


    }




    





const saveCellToDatabase = async function (cell) {  

    if (cell.i === undefined || cell.j === undefined) {
        console.error('i or j not set');
        return false;
    }
    // get description
    if (!cell.description) {
        console.error('No text message found');
        return false;
    }
    if(!cell.voice) {
        console.error('No voice message found');
        return false;
    }
    
    if(!cell.imgURL) {
        console.error('No image found');
        return false;
    }

    const payload = {
        x: cell.i,
        y: cell.j,
        image: cell.imgURL,
        voice: cell.voice,
        description: cell.description
    };

    const payloadString = JSON.stringify(payload);
    return fetch('http://localhost:3000/grid/cell', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: payloadString
    });

    }


    
    function speechBubble(innerHTML){
    const bubble = document.createElement('div');
    bubble.innerHTML = innerHTML;
    // add classes .bubble .medium
    bubble.classList.add('bubble');
    return bubble;
}

function showCellDetails(){
    cell = grid.activeCell;
    // speech bubble top right with cell description
    console.log(cell);
    // const bubble = speechBubble("<div style='height:100%; overflow:scroll'></div>");
    const bubble = speechBubble("");
    // make sure it's independent of everything in the top right conrer
    bubble.style.position = 'absolute';
    document.body.appendChild(bubble);
    
    // voice-message
    const voiceMessage = document.createElement('audio-message');
    // first child of bubble
    // bubbleInternal = bubble.children[0];
    bubble.appendChild(voiceMessage);
    voiceMessage.setAudioFromBase64String(cell.voice, true, 1000);
    

   // horizontally align in the center
    bubble.style.right = '20px';
    // vertically align at the top
    bubble.style.top = '20px';

    // // 30% height
    bubble.style.height = '100px';

    bubble.style.width = '30%';
    bubble.style.zIndex = '1000'; 
    // add 'left' class to make it point to the left
    bubble.classList.add('left');
    bubble.classList.add('animateAppearance')


    // below this one, another speech bubble with the description

    const description = cell.description;
    const descriptionBubble = speechBubble(description);
    descriptionBubble.style.position = 'absolute';
    descriptionBubble.style.right = '20px';
    descriptionBubble.style.top = '150px';
    descriptionBubble.style.height = '120px';
    descriptionBubble.style.width = '30%';
    descriptionBubble.style.zIndex = '1000';
    descriptionBubble.classList.add('left');
    descriptionBubble.classList.add('slowappear');
    document.body.appendChild(descriptionBubble);


    

}

function hideCellDetails(){
    // remove all bubbles
    const bubbles = document.querySelectorAll('.bubble');
    bubbles.forEach(bubble => {
        bubble.remove();
    });
}


document.addEventListener('activeCellChange', (event) => {
    console.log('activeCellChange event received in global scope');
    hideCellDetails();
    // if cell has image, show details
    if(grid.activeCell.img) {
        const activeCellCoordinates = [grid.activeCell.i, grid.activeCell.j];
        setTimeout(()=>{
            // check if the active cell is still the same
            if(activeCellCoordinates[0] === grid.activeCell.i && activeCellCoordinates[1] === grid.activeCell.j) {
            }

        }, 800);
    }
    // find bouncyBall

    // let everyone know that I' here
    
    socket.emit('user-moved', {
        i: grid.activeCell.i,
        j: grid.activeCell.j,
        hue: bounceBall.hue
        
    });
});


// socket.io
const socket = io();
socket.on('connect', () => {
    console.log('Connected to server');
    socket.emit('join', 'client');
});

// listen to new cell created event
socket.on('new-cell-created', (cell) => {
    
    console.log('New cell received:', cell);
    updateCell(cell.x, cell.y);
});
//
var otherUserBalls = [];
// listen to active cell change event
socket.on('user-moved', (data) => {
    console.log('Active cell change event received:', data);
    // find the bouncy ball with same socket id
    let ball = otherUserBalls.find(ball => ball.socketId === data.socketId);
    if(!ball) {
        ball = new BouncyBall(
            grid.cells[data.i][data.j].position.x, 
            grid.cells[data.i][data.j].position.y+ grid.cells[data.i][data.j].height/2 - 10, 20, 
            data.hue, 150);
            ball.socketId = data.socketId;
            otherUserBalls.push(ball);
    }
//target = createVector(event.detail.cell.position.x, event.detail.cell.position.y + event.detail.cell.height / 2 - 25);
    ball.target = createVector(grid.cells[data.i][data.j].position.x, grid.cells[data.i][data.j].position.y + grid.cells[data.i][data.j].height / 2 - 25);
    
});

socket.on('user-disconnected', (socketId) => {
    console.log('User disconnected:', socketId);
    // remove the ball with the socket id
    disconnectedBall = otherUserBalls.find(ball => ball.socketId === socketId);
    console.log('Disconnected ball:', disconnectedBall);
    otherUserBalls = otherUserBalls.filter(ball => ball.socketId !== socketId);
});

</script>
</html>


