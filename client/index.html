<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isotown</title>
    <link rel="stylesheet" href="pixelspeechbubbles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="p5viewerclass.js"></script>
    <script src="bouncyBallClass.js"></script>
    <script src="cellclass.js"></script>
    <script src="gridclass.js"></script>
    <script src="viewmode.js"></script>
    <script src="sketch.js" defer></script>
    <link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet">
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
    <script src="intro-to-index.js" defer></script>
    <script type="module" src="./editcellComponent.js"></script>
    <script src="audiomessage-component.js"></script>
    <script src="textmessage-component.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="index.css">
    <!-- mainnavigagtion.js -->
    <script src="mainnavigation.js" defer></script>
</head>



<body>

<main-navigation
    onnortheast="grid.stepNorthEast()"
    onsoutheast="grid.stepSouthEast()"
    onsouthwest="grid.stepSouthWest()"
    onnorthwest="grid.stepNorthWest()"
    onmessage="()=>{console.log('message button pressed')}"
    onplus="viewMode.editCellStart()">
</main-navigation>

<cell-editor></cell-editor>



</body>

<script>



    // listen for         this.dispatchEvent(new CustomEvent('cancel-editing-cell'));
    document.addEventListener('cancel-editing-cell', () => {
        console.log('cancel-editing-cell event received');
        viewMode.editCellStop();
        viewMode.placeBuildingStop();
    });

    // listen for cell-editing-finished
    document.addEventListener('cell-editing-finished', async () => {
        console.log('cell-editing-finished event received');
        const cellEditor = document.querySelector('cell-editor');
        const cell = await cellEditor.getCell();
        viewMode.editCellStop();
        viewMode.placeBuildingStart(cell);
    });

   

    // leave a cookie so we know the user has been here before

    confirmPlacingCell = async function () {
        if(!placeBuildingMode) {
            console.error('Not in place building mode');
            return;
        }
        if(!buildingToPlace) {
            console.error('No building to place');
            return;
        }

        var cell = buildingToPlace;
        // get active cell 
        cell.i = grid.activeCell.i;
        cell.j = grid.activeCell.j;
        console.log('Placing cell:', cell);
        saveCellToDatabase(cell).then(response => {
            // if 409 conflict, alert user
            if(response.status === 409) {
                alert('Sorry, someone built something here just this second... please choose another place.');
                return;
            }
            if(response.status !== 201) {
                console.error('Error saving cell:', response);
                return;
            }
            if(response.status === 201) {
                console.log('Cell saved successfully');
                const cellEditor = document.querySelector('cell-editor');
                cellEditor.resetAll();
                viewMode.placeBuildingStop();
            }

            // in any case, pull the updated cell data from the server
            updateCell(cell.i, cell.j);

            viewMode.placeBuildingStop();
            viewMode.defaultStart();

            
        }).catch(error => {
            console.error('Error saving cell:', error);
        });


    }




    





const saveCellToDatabase = async function (cell) {  

    if (cell.i === undefined || cell.j === undefined) {
        console.error('i or j not set');
        return false;
    }
    // get description
    if (!cell.description) {
        console.error('No text message found');
        return false;
    }
    if(!cell.voice) {
        console.error('No voice message found');
        return false;
    }
    
    if(!cell.imgURL) {
        console.error('No image found');
        return false;
    }

    const payload = {
        x: cell.i,
        y: cell.j,
        image: cell.imgURL,
        voice: cell.voice,
        description: cell.description
    };

    const payloadString = JSON.stringify(payload);
    return fetch('http://localhost:3000/grid/cell', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: payloadString
    });

    }

    

</script>
</html>


